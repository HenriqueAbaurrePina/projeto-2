apiVersion: batch/v1
kind: Job
metadata:
  name: kibana-create-indexpattern
spec:
  template:
    spec:
      containers:
        - name: indexpattern-creator
          image: curlimages/curl:8.2.1
          command:
            - sh
            - -c
            - |
              echo "⏳ Aguardando Kibana..."
              until curl -s http://kibana:5601 > /dev/null; do sleep 5; done
              echo "✅ Kibana disponível. Enviando index pattern..."
              curl -s -X POST http://kibana:5601/api/saved_objects/index-pattern \
                -H "kbn-xsrf: true" \
                -H "Content-Type: application/json" \
                -d '{"attributes":{"title":"php-logs","timeFieldName":"@timestamp"}}' || true
              echo "✅ Index pattern criado ou já existente."
      restartPolicy: OnFailure
