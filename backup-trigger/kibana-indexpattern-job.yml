apiVersion: batch/v1
kind: Job
metadata:
  name: create-kibana-indexpattern
spec:
  template:
    spec:
      containers:
        - name: create-indexpattern
          image: curlimages/curl:8.2.1
          command:
            - sh
            - -c
            - |
              echo "‚è≥ Aguardando Elasticsearch responder..."
              until curl -s http://elasticsearch:9200 > /dev/null; do sleep 3; done

              echo "üì§ Enviando log artificial para criar o √≠ndice 'php-logs'..."
              curl -s -X POST "http://elasticsearch:9200/php-logs/_doc" \
                -H 'Content-Type: application/json' \
                -d '{
                      "datetime":"'"$(date -Is)"'",
                      "level":200,
                      "level_name":"INFO",
                      "message":"Kibana iniciado pelo Job",
                      "context":{},
                      "channel":"app"
                    }'

              echo "‚è≥ Aguardando Kibana ficar dispon√≠vel..."
              until curl -s http://kibana:5601 > /dev/null; do sleep 3; done

              echo "üì° Verificando se o index pattern j√° existe..."
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://kibana:5601/api/saved_objects/index-pattern/php-logs)

              if [ "$STATUS" -ne 200 ]; then
                echo "üÜï Criando index pattern 'php-logs'..."
                curl -s -X POST http://kibana:5601/api/saved_objects/index-pattern/php-logs \
                  -H "kbn-xsrf: true" \
                  -H "Content-Type: application/json" \
                  -d '{"attributes":{"title":"php-logs","timeFieldName":"datetime"}}'
              else
                echo "‚úÖ Index pattern j√° existe"
              fi

              echo "‚≠ê Definindo index pattern 'php-logs' como padr√£o no Kibana..."
              curl -s -X POST http://kibana:5601/api/kibana/settings/defaultIndex \
                -H "kbn-xsrf: true" \
                -H "Content-Type: application/json" \
                -d '{"value": "php-logs"}'

              echo "‚úÖ Configura√ß√£o finalizada."
      restartPolicy: OnFailure
