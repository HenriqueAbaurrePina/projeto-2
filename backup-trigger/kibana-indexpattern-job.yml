apiVersion: batch/v1
kind: Job
metadata:
  name: kibana-indexpattern-job
spec:
  template:
    spec:
      containers:
        - name: create-indexpattern
          image: curlimages/curl:8.2.1
          command:
            - sh
            - -c
            - |
              echo "â³ Aguardando Elasticsearch responder..."
              until curl -s http://elasticsearch:9200 > /dev/null; do sleep 3; done

              echo "ðŸ“¤ Enviando log artificial para criar o Ã­ndice 'php-logs'..."
              curl -s -X POST "http://elasticsearch:9200/php-logs/_doc" \
                -H 'Content-Type: application/json' \
                -d '{"@timestamp":"'"$(date -Is)"'","level":"info","message":"Kibana iniciado pelo Job","context":{}}'

              echo "â³ Aguardando Kibana ficar disponÃ­vel..."
              until curl -s http://kibana:5601 > /dev/null; do sleep 3; done

              echo "ðŸ“¡ Verificando se o index pattern jÃ¡ existe..."
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://kibana:5601/api/saved_objects/index-pattern/php-logs)
              if [ "$STATUS" -ne 200 ]; then
                echo "ðŸ†• Criando index pattern php-logs"
                curl -s -X POST http://kibana:5601/api/saved_objects/index-pattern \
                  -H "kbn-xsrf: true" \
                  -H "Content-Type: application/json" \
                  -d '{"attributes":{"title":"php-logs","timeFieldName":"@timestamp"}}'
              else
                echo "âœ… Index pattern jÃ¡ existe"
              fi
      restartPolicy: OnFailure
